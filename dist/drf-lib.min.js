var errorModule=angular.module("drf-lib.error",["angular.filter"]),errorParser=function(e,r,t){this.ucfirstFilter=r,this.lowercaseFilter=e,this.$window=t};errorParser.$inject=["lowercaseFilter","ucfirstFilter","$window"],errorParser.prototype.extractMessage=function(e){var r,t,n,o,a=this;if(e.data&&e.data.non_field_errors)return e.data.non_field_errors.join(" ");if(e.data&&e.data.detail)return e.data.detail;if(e.data&&angular.isArray(e.data)){for(t=[],r=0;r<e.data.length;r++)t.push(a.extractMessage(e.data[r]));return t.join(", ")}if(400==e.status){if(angular.isString(e.data))return e.data;n="";for(o in e.data)n+=a.ucfirstFilter(a.lowercaseFilter(o))+": "+e.data[o]+" ";return n}if(e.statusText)return a.ucfirstFilter(a.lowercaseFilter(e.statusText));if(e.status==-1)return a.$window.navigator.onLine?"Server unavailable":"Network unavailable";if(e.message)return e.message;if(angular.isString(e))return e;if(angular.isObject(e)){n="";for(o in e)n+=a.ucfirstFilter(a.lowercaseFilter(o))+": "+e[o]+" ";return n}return"Service unavailable"},errorModule.service("errorParser",errorParser),angular.module("drf-lib.util",[]).filter("humanize",function(){return function(e){return s.humanize(e)}}).factory("phoneUtils",function(){return phoneUtils.parsePhoneNumber=function(e,r,t){try{if(phoneUtils.isPossibleNumber(e,t)){if(!r||"e164"==r)return phoneUtils.formatE164(e,t);if("national"==r)return phoneUtils.formatNational(e,t)}}catch(n){return null}},phoneUtils.checkValidNumber=function(e,r){try{return phoneUtils.isPossibleNumber(e,r)}catch(t){return!1}},phoneUtils}).service("restServiceHelper",["drfUtil","$resource",function(e,r){var t=this;t.createListFunction=function(r,t,n){return function(o){o=e.underscoredProperties(o)||{},n=n||"get";var a=r[n](o).$promise;return t||(t=function(e){return e}),a.then(function(e){if(e.hasOwnProperty("results")){var r=e.results;return angular.isNumber(e.count)&&(r.count=e.count),r}return e}).then(t)}},t.resourceWithExtraHeaders=function(e,t,n,o,a){var i,u={get:{method:"GET",headers:e},query:{method:"GET",isArray:!0,headers:e},save:{method:"POST",headers:e},remove:{method:"DELETE",headers:e},"delete":{method:"DELETE",headers:e},update:{method:"PATCH",headers:e}};for(i in o)o.hasOwnProperty(i)&&(o[i].headers=e,u[i]=o[i]);return r(t,n,u,a)}}]).service("drfUtil",["$window","$q",function(e,r){function t(e){function r(t){var n;if(angular.isDate(t))return t;if(angular.isArray(t)){for(var o=t,a=[],i=0;i<o.length;i++)a.push(r(o[i]));n=a}if(angular.isObject(t)||angular.isArray(t)){var u=t,s=n||{};for(var l in u)u.hasOwnProperty(l)&&0!==l.indexOf("$")&&!angular.isNumber(l)&&(angular.isObject(u[l])?s[e(l)]=r(u[l]):s[e(l)]=u[l]);n=s}return n}return r}var n=this,o=e.s;n.camelizeProperties=t(o.camelize),n.underscoredProperties=t(o.underscored),n.wrapMethod=function(e,r,t){return function(){r();var n=e.apply(this,arguments);return n&&n["finally"]?n["finally"](function(){t()}):(t(),n)}},n.wrapMethods=function(e,r,t){var o=angular.copy(e);o.wrapped={};for(var a in e)if(angular.isFunction(e[a])){var i=function(r){return function(){return r.apply(e,arguments)}};o.wrapped[a]=n.wrapMethod(i(e[a]),r,t)}return o},n.uuid4=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var r=16*Math.random()|0,t="x"==e?r:3&r|8;return t.toString(16)})}}]),angular.module("drf-lib.auth.rest",["ngResource","rest-api.url"]).service("authRest",["$http","urlOf","$q","drfUtil",function(e,r,t,n){function o(e){if(200==e.status)return e.data.key;throw e}var a=this;a.login=function(t,n){return e.post(r.login,{username:t,password:n}).then(o)},a.jwt=function(t){return e({method:"GET",url:r.jwt,headers:{Authorization:"Token "+t}}).then(function(e){return 200==e.status?e.data.token:e})},a.externalLogin=function(a,i){return i=n.underscoredProperties(i),r[a+"-login"]?e.post(r[a+"-login"],i).then(o):t.reject({provider:a})},a.logoutEverywhere=function(){return e.post(r.logout)}}]);var authModule=angular.module("drf-lib.auth.services",["drf-lib.auth.rest","drf-lib.user.rest","drf-lib.error","angular-jwt"]).service("authInterceptor",["$injector","urlService","$q",function(e,r,t){return{responseError:function(n){var o=e.get("authService"),a=n.config;return 401==n.status&&r.domainRequiresAuthorization(a.url)?o.tryReconnect(n):t.reject(n)},request:function(t){var n=e.get("authService");return r.domainRequiresAuthorization(t.url)?t.headers&&t.headers.Authorization?t:n.setAuthHeader(t):t}}}]).config(["$httpProvider",function(e){e.interceptors.push("authInterceptor")}]),authService=function(e,r,t,n,o,a,i,u,s,l,c){var h=this;h.$timeout=u,h.jwtHelper=i,h.authRest=e,h.$localStorage=r,h.$injector=t,h.$log=n,h.loginCallbacks=l,h.logoutCallbacks=c,h.userRest=o,h.errorParser=a,h.$q=s};authService.prototype.initialLogin=function(e){var r=this;return r.$localStorage.auth&&r.$localStorage.auth.token?r.setIdentity(r.$localStorage.auth.token,r.$localStorage.auth.username,e):r.$q.when(null)},authService.prototype.tryReconnect=function(e){var r=this;return!r.reconnecting&&r.$localStorage.auth&&r.$localStorage.auth.token?(r.refreshPromise&&(r.$timeout.cancel(r.refreshPromise),delete r.refreshPromise),r.reconnecting=!0,r.setIdentity(r.$localStorage.auth.token,r.$localStorage.auth.username,!0)["catch"](function(t){return r.$q.reject(e)}).then(function(t){var n=r.$injector.get("$http");return n(e.config)})["finally"](function(){r.reconnecting=!1})):r.$q.reject(e)},authService.prototype.login=function(e,r){var t=this;return t.authRest.login(e,r).then(function(r){return t.setIdentity(r,e)}).then(function(){return t.userRest.getProfile()["catch"](function(e){var r=t.errorParser.extractMessage(e);throw t.$log.error("Could not load user profile: "+r),e})})},authService.prototype.externalLogin=function(e,r){var t=this;return t.authRest.externalLogin(e,r).then(function(e){return t.setIdentity(e,null)}).then(function(){return t.userRest.getProfile().then(function(e){return t.$localStorage.auth.username=e.username,e})["catch"](function(e){var r=t.errorParser.extractMessage(e);throw t.$log.error("Could not load user profile: "+r),e})})},authService.prototype.setUserRefresh=function(e,r,t){var n=this;if(!n.refreshPromise)try{var o=n.jwtHelper.getTokenExpirationDate(e);r=r||5e3,t=t||1e4;var a=Math.max(o.getTime()-Date.now()-r,t);n.refreshPromise=n.$timeout(function(){delete n.refreshPromise,n.setJWT(r,t)},a)}catch(i){n.$log.error("Could not set user refresh timer due to "+i)}},authService.prototype.setIdentity=function(e,r,t,n,o){var a=this;return a.$localStorage.auth={token:e,username:r},a.setJWT(n,o).then(function(n){if(!t)for(var o=0;o<a.loginCallbacks.length;o++){var i=a.loginCallbacks[o];try{a.$injector.invoke(i,null,{token:e,username:r,authService:a})}catch(u){a.$log.error("error running login callback: "+u)}}return n})},authService.prototype.setJWT=function(e,r){var t=this;return t.getToken()?(t.savedJWTPromise||(t.savedJWTDeferred=t.$q.defer(),t.savedJWTPromise=t.savedJWTDeferred.promise),t.authRest.jwt(t.getToken()).then(function(n){t.refreshErrorDelay=0,t.savedJWT=n,t.setUserRefresh(n,e,r);try{t.savedJWTDeferred.resolve(n),delete t.savedJWTPromise,delete t.savedJWTDeferred}catch(o){}})["catch"](function(n){try{t.savedJWTDeferred.reject(n),delete t.savedJWTPromise,delete t.savedJWTDeferred}catch(o){}!t.refreshPromise&&(n.status<0||n.status>=500)&&(t.refreshErrorDelay=t.refreshErrorDelay||1e3*(Math.random()+1),n.status>=500&&(t.refreshErrorDelay*=2,t.refreshErrorDelay=Math.min(t.refreshErrorDelay,9e5)),t.refreshPromise=t.$timeout(function(){delete t.refreshPromise,t.setJWT(e,r)},t.refreshErrorDelay))}),t.savedJWTPromise):t.$q.reject(new Error("No token set"))},authService.prototype.logout=function(e,r){var t=this;if(t.$localStorage.auth&&delete t.$localStorage.auth,t.refreshPromise&&(t.$timeout.cancel(t.refreshPromise),delete t.refreshPromise),t.savedJWT&&delete t.savedJWT,t.savedJWTDeferred&&(t.savedJWTDeferred.reject(new Error("Logged out")),delete t.savedJWTDeferred),t.savedJWTPromise&&delete t.savedJWTPromise,!e)for(var n=0;n<t.logoutCallbacks.length;n++){var o=t.logoutCallbacks[n];try{t.$injector.invoke(o,t,{authService:t,response:r})}catch(a){t.$log.error("error running logout callback: "+a)}}},authService.prototype.logoutEverywhere=function(){var e=this;return e.authRest.logoutEverywhere().then(function(r){return e.logout(),r})},authService.prototype.getToken=function(){var e=this;if(e.$localStorage.auth)return e.$localStorage.auth.token},authService.prototype.setUsername=function(e){var r=this;if(!r.$localStorage.auth)throw"Not logged in";r.$localStorage.auth.username=e},authService.prototype.getUsername=function(){var e=this;if(e.$localStorage.auth)return e.$localStorage.auth.username},authService.prototype.setAuthHeader=function(e){var r=this;if(r.isAuthenticated())return e.headers=e.headers||{},e.headers.Authorization="JWT "+r.savedJWT,e;if(r.getToken()){return!r.savedJWT&&r.savedJWTPromise?r.savedJWTPromise.then(function(t){return t&&!r.jwtHelper.isTokenExpired(t)&&(e.headers=e.headers||{},e.headers.Authorization="JWT "+t),e}):(r.refreshPromise&&(r.$timeout.cancel(r.refreshPromise),delete r.refreshPromise),r.setIdentity(r.$localStorage.auth.token,r.$localStorage.auth.username,!0).then(function(t){return t&&!r.jwtHelper.isTokenExpired(t)&&(e.headers=e.headers||{},e.headers.Authorization="JWT "+t),e})["catch"](function(){return e}))}return e},authService.prototype.isAuthenticated=function(){var e=this;return e.savedJWT&&!e.jwtHelper.isTokenExpired(e.savedJWT)},authModule.provider("authService",function(){var e=this,r=[],t=[];e.addLoginCallback=function(e){r.push(e)},e.addLogoutCallback=function(e){t.push(e)},e.$get=["authRest","$localStorage","$injector","$log","userRest","errorParser","jwtHelper","$timeout","$q",function(e,n,o,a,i,u,s,l,c){return new authService(e,n,o,a,i,u,s,l,c,r,t)}]}),angular.module("drf-lib.user.rest",["ngResource","rest-api.url"]).service("userRest",["$resource","urlOf","$http","drfUtil",function(e,r,t,n){var o=this,a=function(e){return n.camelizeProperties(e)},i=function(e){return e.data};o.getProfile=function(){var t=e(r["rest-auth-user-self"]);return t.get().$promise.then(a)},o.setProfile=function(t){t=n.underscoredProperties(t);var o=e(r["rest-auth-user-self"],void 0,{update:{method:"PUT"}}),i=new o(t);return i.$update().then(a)},o.setPassword=function(e,n){return t.post(r["rest-auth-set-password"],{new_password1:e,new_password2:n}).then(i).then(a)},o.registerUser=function(e,n,o,u){var s={username:e,password1:o,password2:o,email:u};return t.post(r["rest-auth-register"],s).then(i).then(a)},o.resetPassword=function(e){return t.post(r["rest-auth-reset-password"],{email:e}).then(i).then(a)},o.confirmResetPassword=function(e,n,o,u){var s={uid:e,token:n,new_password1:o,new_password2:u};return t.post(r["rest-auth-confirm-reset"],s).then(i).then(a)},o.linkExternalLogin=function(e,o){return o=n.underscoredProperties(o),r[e+"-login"]?t.post(r[e+"-login"]+"?process=connect",o).then(function(e){return e.data}).then(a):$q.reject({provider:e})},o.disconnectExternalLogin=function(t,n){var o=e(r["rest-auth-user-external-login"]);return o.remove({username:t.username,externalLoginId:n}).$promise.then(a)}}]);